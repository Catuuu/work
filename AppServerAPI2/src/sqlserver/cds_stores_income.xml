<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC
        "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cds_stores_income">
    <select id="select" parameterType="Map" resultType="HashMap">
        select s.stores_id,s.name,si.month_income  from cds_stores s left join cds_stores_income si on s.stores_id = si.stores_id
            AND DateName(year,date_month) = DateName(year,getDate())
        <if test="create_date==null">
            AND DateName(month,date_month) = DateName(month,getDate())
        </if>
            <if test="create_date!='' and month !=create_date">
                and DateName(month,date_month) = #{create_date}
            </if>
    </select>

    <select id="saveOrUpdate" parameterType="Map" resultType="HashMap">
          if exists(select date_month from cds_stores_income where DateName(month,date_month) = #{create_date} and DateName(year,date_month) = #{year})
        BEGIN
          <foreach collection="updateList" item="uItem">
              update cds_stores_income set month_income = #{uItem.month_income} where stores_id = #{uItem.stores_id} and DateName(month,date_month) = #{create_date} and DateName(year,date_month) = #{year}
          </foreach>
        END
        ELSE
        BEGIN
        <foreach collection="insertList" item="iItem">
            INSERT into cds_stores_income values(#{iItem.stores_id},#{year}+'-'+#{create_date}+'-01',#{iItem.month_income})
        </foreach>
        END
    </select>

</mapper>