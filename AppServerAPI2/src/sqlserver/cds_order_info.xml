<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC
        "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cds_order_info">
    <select id="GetAllGoods" resultType="CdsOrderInfo">
        select goods from cds_order_info
    </select>
    <!--订单分页数据查询-->
    <select id="getPageRecord" parameterType="PageParam" resultType="HashMap">
        <![CDATA[
            select
            DATEDIFF(minute,o.create_date,o.pack_user_time)   as pack_time,
            DATEDIFF(minute,o.create_date,getdate()) as pack_wait_time,
            DATEDIFF(minute,isnull(o.pack_user_time,o.create_date),o.task_user_time) as takemea_time,
            DATEDIFF(minute,isnull(o.pack_user_time,o.create_date),getdate()) as takemea_wait_time,
            DATEDIFF(minute,isnull(o.task_order_time,o.create_date),o.task_time) as use_send_time,
            DATEDIFF(minute,isnull(isnull(o.task_user_time,o.pack_user_time),o.create_date),getdate()) as use_send_wait_time,
            s.name stores_name,
            b.brand_name,
            o.*
            from cds_order_info o
            left join cds_stores s on o.stores_id = s.stores_id
            left join cds_brand b on o.brand_id = b.brand_id
        ]]>
        <where>
            <if test="formInfo.sl_date_begin != null and formInfo.sl_date_begin != '' ">
                <![CDATA[ o.create_date >= #{formInfo.sl_date_begin} ]]>
            </if>
            <if test="formInfo.sl_date_end != null and formInfo.sl_date_end != '' ">
                <![CDATA[ AND o.create_date <= #{formInfo.sl_date_end} + ' 23:59:59'  ]]>
            </if>
            <if test="formInfo.isprint != null and formInfo.isprint != '' ">
                <![CDATA[ AND o.isstoresprint = #{formInfo.isprint} ]]>
            </if>
            <if test="formInfo.order_type != null and formInfo.order_type != '' ">
                <![CDATA[ AND o.order_type = #{formInfo.order_type} ]]>
            </if>
            <if test="formInfo.send_name != null and formInfo.send_name != '' ">
                <![CDATA[ AND o.send_name = #{formInfo.send_name} ]]>
            </if>
            <if test="formInfo.stores_id != null and formInfo.stores_id != '' ">
                <![CDATA[ AND o.stores_id = #{formInfo.stores_id} ]]>
            </if>
            <if test="formInfo.pay_type_id != null and formInfo.pay_type_id != '' ">
                <![CDATA[ AND o.pay_type_id = #{formInfo.pay_type_id} ]]>
            </if>
            <if test="formInfo.brand_id != null and formInfo.brand_id != '' and formInfo.brand_id != 0">
                <![CDATA[ AND o.brand_id = #{formInfo.brand_id} ]]>
            </if>
            <if test="formInfo.keywords != null and formInfo.keywords != '' ">
                <![CDATA[
                    AND (
                        o.order_id LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.order_no LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.order_desc LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.fromin_no LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.receiver_name LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.receiver_phone LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.receiver_adress LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.task_user_name LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.task_user_phone LIKE '%'+#{formInfo.keywords}+'%'
                      )
                ]]>
            </if>
            <if test="formInfo.fromin_no != null and formInfo.fromin_no != ''">
                <![CDATA[ AND o.fromin_no LIKE #{formInfo.fromin_no} ]]>
            </if>
            <if test='formInfo.remark != null and formInfo.remark =="1"'>
                <![CDATA[ AND o.member_desc is not null and o.member_desc !='']]>
            </if>
            <if test='formInfo.remark != null and formInfo.remark =="2"'>
                <![CDATA[ AND (o.member_desc is null or o.member_desc = '')]]>
            </if>
            <choose>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "1"'>
                    AND o.order_status = 0
                </when>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "2"'>
                    AND (o.order_status = 1 or o.order_status = 2) and o.pack_user_time is null
                </when>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "3"'>
                    AND (o.order_status = 1 or o.order_status = 2) and o.pack_user_time is not null
                </when>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "4"'>
                    AND o.order_status = 3
                </when>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "5"'>
                    AND o.order_status = 4
                </when>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "6"'>
                    AND o.order_status = 99
                </when>
                <otherwise>

                </otherwise>
            </choose>
            <choose>
                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "1"'>
                    AND o.fromin = '饿了么'
                </when>
                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "2"'>
                    AND o.fromin = '美团'
                </when>
                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "3"'>
                    AND o.fromin = '百度外卖'
                </when>

                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "4"'>
                    AND o.fromin = '微信'
                </when>
            </choose>
        </where>
    </select>






    <!--历史订单分页数据查询-->
    <select id="getHistoryPageRecord" parameterType="PageParam" resultType="HashMap">
        <![CDATA[
            select
            DATEDIFF(minute,o.create_date,o.pack_user_time)   as pack_time,
            DATEDIFF(minute,o.create_date,getdate()) as pack_wait_time,
            DATEDIFF(minute,isnull(o.pack_user_time,o.create_date),o.task_user_time) as takemea_time,
            DATEDIFF(minute,isnull(o.pack_user_time,o.create_date),getdate()) as takemea_wait_time,
            DATEDIFF(minute,isnull(o.task_order_time,o.create_date),o.task_time) as use_send_time,
            DATEDIFF(minute,isnull(isnull(o.task_user_time,o.pack_user_time),o.create_date),getdate()) as use_send_wait_time,
            s.name stores_name,
            b.brand_name,
            o.*
            from view_cds_order_info o
            left join cds_stores s on o.stores_id = s.stores_id
            left join cds_brand b on o.brand_id = b.brand_id
        ]]>
        <where>
            <if test="formInfo.sl_date_begin != null and formInfo.sl_date_begin != '' ">
                <![CDATA[ o.create_date >= #{formInfo.sl_date_begin} ]]>
            </if>
            <if test="formInfo.sl_date_end != null and formInfo.sl_date_end != '' ">
                <![CDATA[ AND o.create_date <= #{formInfo.sl_date_end} + ' 23:59:59'  ]]>
            </if>
            <if test="formInfo.isprint != null and formInfo.isprint != '' ">
                <![CDATA[ AND o.isstoresprint = #{formInfo.isprint} ]]>
            </if>
            <if test="formInfo.order_type != null and formInfo.order_type != '' ">
                <![CDATA[ AND o.order_type = #{formInfo.order_type} ]]>
            </if>
            <if test="formInfo.send_name != null and formInfo.send_name != '' ">
                <![CDATA[ AND o.send_name = #{formInfo.send_name} ]]>
            </if>
            <if test="formInfo.stores_id != null and formInfo.stores_id != '' ">
                <![CDATA[ AND o.stores_id = #{formInfo.stores_id} ]]>
            </if>
            <if test="formInfo.pay_type_id != null and formInfo.pay_type_id != '' ">
                <![CDATA[ AND o.pay_type_id = #{formInfo.pay_type_id} ]]>
            </if>
            <if test="formInfo.brand_id != null and formInfo.brand_id != '' and formInfo.brand_id != 0">
                <![CDATA[ AND o.brand_id = #{formInfo.brand_id} ]]>
            </if>
            <if test="formInfo.keywords != null and formInfo.keywords != '' ">
                <![CDATA[
                    AND (
                        o.order_id LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.order_no LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.order_desc LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.fromin_no LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.receiver_name LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.receiver_phone LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.receiver_adress LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.task_user_name LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.task_user_phone LIKE '%'+#{formInfo.keywords}+'%'
                      )
                ]]>
            </if>
            <if test="formInfo.fromin_no != null and formInfo.fromin_no != ''">
                <![CDATA[ AND o.fromin_no LIKE #{formInfo.fromin_no} ]]>
            </if>
            <if test='formInfo.remark != null and formInfo.remark =="1"'>
                <![CDATA[ AND o.member_desc is not null and o.member_desc !='']]>
            </if>
            <if test='formInfo.remark != null and formInfo.remark =="2"'>
                <![CDATA[ AND (o.member_desc is null or o.member_desc = '')]]>
            </if>
            <choose>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "1"'>
                    AND o.order_status = 0
                </when>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "2"'>
                    AND (o.order_status = 1 or o.order_status = 2) and o.pack_user_time is null
                </when>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "3"'>
                    AND (o.order_status = 1 or o.order_status = 2) and o.pack_user_time is not null
                </when>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "4"'>
                    AND o.order_status = 3
                </when>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "5"'>
                    AND o.order_status = 4
                </when>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "6"'>
                    AND o.order_status = 99
                </when>
                <otherwise>

                </otherwise>
            </choose>
            <choose>
                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "1"'>
                    AND o.fromin = '饿了么'
                </when>
                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "2"'>
                    AND o.fromin = '美团'
                </when>
                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "3"'>
                    AND o.fromin = '百度外卖'
                </when>

                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "4"'>
                    AND o.fromin = '微信'
                </when>
            </choose>
        </where>
    </select>


    <select id="viewhistorysendlog" parameterType="Map" resultType="CdsOrderSendLog">
         <![CDATA[
            select *
            from view_cds_order_send_log
            where create_date >#{cday}      and create_date < #{cday} + ' 23:59:59'
            and order_id = #{order_id}
            order by opt_time
          ]]>
    </select>

    <select id="viewhistoryorderlog" parameterType="Map" resultType="CdsOrderLog">
         <![CDATA[
            select *
            from view_cds_order_log
            where create_date >#{cday}      and create_date < #{cday} + ' 23:59:59'
            and order_id = #{order_id}
            order by opt_time
          ]]>
    </select>


    <select id="getOrderNo" parameterType="Map" resultType="HashMap">
        <![CDATA[
            select top 1 convert(int,substring(order_no,6,4)) as order_no
            from cds_order_info
            where create_date >#{cday}
            and create_date < #{cday} + ' 23:59:59'
            and stores_id=#{stores_id}
            and brand_id=#{brand_id}
            order by order_no desc
        ]]>
    </select>

    <!--补单，统计订单数量-->
    <select id="getOrderSum" parameterType="Map" resultType="CdsIncreaseOrder">
        <![CDATA[
            select '${cday}' as cday,sb.stores_brand_id,o.stores_id,o.brand_id,o.fromin,COUNT(1) as all_count,MAX(CAST(o.fromin_no as int)) as max_num,
            DATEDIFF( Second, max(o.create_date), getdate()) as dfsecond
            from cds_order_info o
            left join cds_stores_brand sb on o.stores_id = sb.stores_id and o.brand_id = sb.brand_id
            where create_date>#{cday} and create_date< #{cday} + ' 23:59:59'
            and o.stores_id = #{stores_id}
            group by o.stores_id,o.brand_id,sb.stores_brand_id,o.fromin
            order by o.stores_id,o.brand_id,sb.stores_brand_id,o.fromin
        ]]>
    </select>

    <select id="orderCountBrand" parameterType="Map" resultType="HashMap">
        select distinct bra.* from cds_order_info ori left join cds_brand bra on ori.brand_id = bra.brand_id
        WHERE
        order_status in(1,2,3,4)
        <if test="startday != null and startday != '' ">
            <![CDATA[ AND create_date >= #{startday} ]]>
        </if>
        <if test="endday != null and endday != '' ">
            <![CDATA[ AND create_date <= #{endday} + ' 23:59:59'  ]]>
        </if>
        <if test="stores_id != null and stores_id != '' ">
            <![CDATA[ AND stores_id = #{stores_id} ]]>
        </if>
    </select>

    <select id="orderCountDay" parameterType="Map" resultType="HashMap">
        SELECT
        CONVERT (
        VARCHAR (10),
        create_date,
        120
        ) timeDay,
        SUM(case when fromin = '饿了么' then total_price else 0 end ) elm3,
        SUM(case when fromin = '美团' then total_price else 0 end ) mt3,
        SUM(case when fromin = '微信' then total_price else 0 end ) wx3,
        SUM(case when fromin = '百度外卖' then total_price else 0 end ) bdwm3,
        SUM(total_price) sum3,
        SUM(case when fromin = '饿了么' then 1 else 0 end ) elm1,
        SUM(case when fromin = '美团' then 1 else 0 end ) mt1,
        SUM(case when fromin = '微信' then 1 else 0 end ) wx1,
        SUM(case when fromin = '百度外卖' then 1 else 0 end ) bdwm1,
        count(*) sum1
        FROM
        (
        select goods_prcie+ship_fee+box_price total_price,
        CONVERT (
        VARCHAR (10),
        create_date,
        120
        ) timeDay,fromin,
        CONVERT (
        VARCHAR (10),
        create_date,
        120
        ) create_date,order_status FROM [dbo].[cds_order_info]
        where
        order_status in(1,2,3,4)
        <if test="startday != null and startday != '' ">
            <![CDATA[ AND create_date >= #{startday} ]]>
        </if>
        <if test="endday != null and endday != '' ">
            <![CDATA[ AND create_date <= #{endday} + ' 23:59:59'  ]]>
        </if>
        <if test="stores_id != null and stores_id != '' ">
            <![CDATA[ AND stores_id = #{stores_id} ]]>
        </if>
        <if test="brand_id != null and brand_id != '' ">
            <![CDATA[ AND brand_id = #{brand_id} ]]>
        </if>
        union ALL
        select  goods_prcie+ship_fee+box_price total_price,
        CONVERT (
        VARCHAR (10),
        create_date,
        120
        ) timeDay,fromin,
        CONVERT (
        VARCHAR (10),
        create_date,
        120
        ) create_date,order_status FROM [dbo].[view_cds_order_info]
        where
        order_status in(1,2,3,4)
        <if test="startday != null and startday != '' ">
            <![CDATA[ AND create_date >= #{startday} ]]>
        </if>
        <if test="endday != null and endday != '' ">
            <![CDATA[ AND create_date <= #{endday} + ' 23:59:59'  ]]>
        </if>
        <if test="stores_id != null and stores_id != '' ">
            <![CDATA[ AND stores_id = #{stores_id} ]]>
        </if>
        <if test="brand_id != null and brand_id != '' ">
            <![CDATA[ AND brand_id = #{brand_id} ]]>
        </if>
        ) temp
        <![CDATA[
                GROUP BY create_date
                ORDER BY create_date
                 ]]>
    </select>

    <select id="orderOnTimeCount1" parameterType="Map" resultType="HashMap">
        select
        <foreach item="item" collection="list" separator="" index="index">
            SUM(case when DATEDIFF(minute,create_date,task_time)<![CDATA[<]]> 60 AND stores_id=#{item.storesId} and send_name='点我达' then 1 else 0 end) 'dwdNiceOrder${index}',
            SUM(case when stores_id=#{item.storesId}  and send_name='点我达'  then 1 else 0 end) 'dwdAllOrder${index}',
            SUM(case when DATEDIFF(minute,create_date,task_time)<![CDATA[<]]> 60 AND stores_id=#{item.storesId} and send_name='美团' then 1 else 0 end) 'mtNiceOrder${index}',
            SUM(case when stores_id=#{item.storesId} and send_name='美团' then 1 else 0 end) 'mtAllOrder${index}',
            SUM(case when DATEDIFF(minute,create_date,task_time)<![CDATA[<]]> 60 AND stores_id=#{item.storesId} and send_name='饿了么'  then 1 else 0 end) 'elmNiceOrder${index}',
            SUM(case when stores_id=#{item.storesId} and send_name='饿了么'  then 1 else 0 end) 'elmAllOrder${index}',
        </foreach>
        SUM(case when DATEDIFF(minute,create_date,task_time)<![CDATA[<]]> 60  and send_name='点我达' then 1 else 0 end)  dwdNiceOrder,
        SUM(case when DATEDIFF(minute,create_date,task_time)<![CDATA[<]]> 60  and send_name='美团' then 1 else 0 end)  mtNiceOrder,
        SUM(case when DATEDIFF(minute,create_date,task_time)<![CDATA[<]]> 60 and send_name='饿了么' then 1 else 0 end)  elmNiceOrder,
        SUM(case when send_name='点我达' then 1 else 0 end) dwdAllOrder,
        SUM(case when send_name='美团' then 1 else 0 end) mtAllOrder,
        SUM(case when send_name='饿了么' then 1 else 0 end) elmAllOrder,
        isnull(CONVERT (
        VARCHAR (10),
        create_date,
        120
        ),'合计') create_date
        from
        (
        select create_date,task_time,stores_id,send_name FROM [dbo].[cds_order_info]
        where order_status = 4 and service_time is null
        <if test="startday != null and startday != '' ">
            <![CDATA[ AND create_date >= #{startday} ]]>
        </if>
        <if test="endday != null and endday != '' ">
            <![CDATA[ AND create_date <= #{endday} + ' 23:59:59'  ]]>
        </if>
        union ALL
        select create_date,task_time,stores_id,send_name FROM [dbo].[view_cds_order_info]
        where order_status = 4 and service_time is null
        <if test="startday != null and startday != '' ">
            <![CDATA[ AND create_date >= #{startday} ]]>
        </if>
        <if test="endday != null and endday != '' ">
            <![CDATA[ AND create_date <= #{endday} + ' 23:59:59'  ]]>
        </if>
        ) temp
        <![CDATA[
                group by CONVERT (
                    VARCHAR (10),
                        create_date,
                        120
                        )
                with rollup
                order by create_date
                 ]]>
    </select>

    <select id="orderOnTimeCount2" parameterType="Map" resultType="HashMap">
        select
        <foreach item="item" collection="list" separator="" index="index">
            SUM(case when DATEDIFF(minute,service_time,task_time)>=-10 and DATEDIFF(minute,service_time,task_time)<![CDATA[<=]]>10 and stores_id=#{item.storesId} and send_name='点我达' then 1 else 0 end) 'dwdNiceOrder${index}',
            SUM(case when stores_id=#{item.storesId}  and send_name='点我达'  then 1 else 0 end) 'dwdAllOrder${index}',
            SUM(case when DATEDIFF(minute,service_time,task_time)>=-10 and DATEDIFF(minute,service_time,task_time)<![CDATA[<=]]>10 AND stores_id=#{item.storesId} and send_name='美团' then 1 else 0 end) 'mtNiceOrder${index}',
            SUM(case when stores_id=#{item.storesId} and send_name='美团' then 1 else 0 end) 'mtAllOrder${index}',
            SUM(case when DATEDIFF(minute,service_time,task_time)>=-10 and DATEDIFF(minute,service_time,task_time)<![CDATA[<=]]>10 AND stores_id=#{item.storesId} and send_name='饿了么'  then 1 else 0 end) 'elmNiceOrder${index}',
            SUM(case when stores_id=#{item.storesId} and send_name='饿了么'  then 1 else 0 end) 'elmAllOrder${index}',
        </foreach>
        SUM(case when DATEDIFF(minute,service_time,task_time)>=-10 and DATEDIFF(minute,service_time,task_time)<![CDATA[<=]]>10 and send_name='点我达' then 1 else 0 end)  dwdNiceOrder,
        SUM(case when DATEDIFF(minute,service_time,task_time)>=-10 and DATEDIFF(minute,service_time,task_time)<![CDATA[<=]]>10 and send_name='美团' then 1 else 0 end)  mtNiceOrder,
        SUM(case when DATEDIFF(minute,service_time,task_time)>=-10 and DATEDIFF(minute,service_time,task_time)<![CDATA[<=]]>10 and send_name='饿了么' then 1 else 0 end)  elmNiceOrder,
        SUM(case when send_name='点我达' then 1 else 0 end) dwdAllOrder,
        SUM(case when send_name='美团' then 1 else 0 end) mtAllOrder,
        SUM(case when send_name='饿了么' then 1 else 0 end) elmAllOrder,
        isnull(CONVERT (
        VARCHAR (10),
        create_date,
        120
        ),'合计') create_date
        from
        (
        select create_date,task_time,stores_id,send_name,service_time FROM [dbo].[cds_order_info]
        where order_status = 4 and service_time is not null
        <if test="startday != null and startday != '' ">
            <![CDATA[ AND create_date >= #{startday} ]]>
        </if>
        <if test="endday != null and endday != '' ">
            <![CDATA[ AND create_date <= #{endday} + ' 23:59:59'  ]]>
        </if>
        union ALL
        select create_date,task_time,stores_id,send_name,service_time FROM [dbo].[view_cds_order_info]
        where order_status = 4 and service_time is not null
        <if test="startday != null and startday != '' ">
            <![CDATA[ AND create_date >= #{startday} ]]>
        </if>
        <if test="endday != null and endday != '' ">
            <![CDATA[ AND create_date <= #{endday} + ' 23:59:59'  ]]>
        </if>
        ) temp
        <![CDATA[
                group by CONVERT (
                    VARCHAR (10),
                        create_date,
                        120
                        )
                with rollup
                order by create_date
                 ]]>
    </select>

    <select id="orderRiderCount1" parameterType="Map" resultType="HashMap">
        select
        stores_id storesId,
        case when GROUPING(stores_id) = 1 then '合计' else (select name from cds_stores s where s.stores_id = temp.stores_id) end storesName,
        <foreach collection="list" index="index" item="item">
            SUM(case when Convert(varchar(10),create_date,120) = #{item} then 1 else 0 end ) as 'orderCount${index}',
            isnull(SUM(case when Convert(varchar(10),create_date,120) = #{item} then abs(DATEDIFF(minute,create_date,task_time)) else 0 end ),0) as 'sumTime${index}',
        </foreach>
        task_order_name taskOrderName,
        task_order_phone taskOrderPhone,
        count(1) orderCount,
        isnull(sum(abs(DATEDIFF(minute,create_date,task_time))),0) sumTime
        from
        (
        select
        *
        FROM cds_order_info
        where order_status = 4
        and service_time is null
        and task_order_name is not null
        <if test="stores_id != null and stores_id != '' ">
            <![CDATA[ AND stores_id = #{stores_id} ]]>
        </if>
        <if test="startday != null and startday != '' ">
            <![CDATA[ AND create_date >= #{startday} ]]>
        </if>
        <if test="endday != null and endday != '' ">
            <![CDATA[ AND create_date <= #{endday} + ' 23:59:59'  ]]>
        </if>
        UNION ALL
        select
        *
        from [dbo].[view_cds_order_info]
        where order_status = 4
        and service_time is null
        and task_order_name is not null
        <if test="stores_id != null and stores_id != '' ">
            <![CDATA[ AND stores_id = #{stores_id} ]]>
        </if>
        <if test="startday != null and startday != '' ">
            <![CDATA[ AND create_date >= #{startday} ]]>
        </if>
        <if test="endday != null and endday != '' ">
            <![CDATA[ AND create_date <= #{endday} + ' 23:59:59'  ]]>
        </if>
        ) temp
        group by stores_id,task_order_phone,task_order_name
        with rollup
        having GROUPING(stores_id) = 1 or GROUPING(stores_id) = 0 and task_order_name is not null
    </select>


    <select id="orderRiderCount2" parameterType="Map" resultType="HashMap">
        select
        stores_id storesId,
        case when GROUPING(stores_id) = 1 then '合计' else (select name from cds_stores s where s.stores_id = temp.stores_id) end storesName,
        <foreach collection="list" index="index" item="item">
            SUM(case when Convert(varchar(10),create_date,120) = #{item} then 1 else 0 end ) as 'orderCount${index}',
            isnull(SUM(case when Convert(varchar(10),create_date,120) = #{item} then abs(DATEDIFF(minute,service_time,task_time)) else 0 end ),0) as 'sumTime${index}',
        </foreach>
        task_order_name taskOrderName,
        task_order_phone taskOrderPhone,
        count(1) orderCount,
        isnull(sum(abs(DATEDIFF(minute,service_time,task_time))),0) sumTime
        from
        (
        select
        *
        from cds_order_info
        where order_status = 4
        and task_order_name is not null
        and service_time is not null
        <if test="startday != null and startday != '' ">
            <![CDATA[ AND create_date >= #{startday} ]]>
        </if>
        <if test="endday != null and endday != '' ">
            <![CDATA[ AND create_date <= #{endday} + ' 23:59:59'  ]]>
        </if>
        <if test="stores_id != null and stores_id != '' ">
            <![CDATA[ AND stores_id = #{stores_id} ]]>
        </if>
        UNION ALL
        select
        *
        from [dbo].[view_cds_order_info]
        where order_status = 4
        and service_time is not null
        and task_order_name is not null
        <if test="startday != null and startday != '' ">
            <![CDATA[ AND create_date >= #{startday} ]]>
        </if>
        <if test="endday != null and endday != '' ">
            <![CDATA[ AND create_date <= #{endday} + ' 23:59:59'  ]]>
        </if>
        <if test="stores_id != null and stores_id != '' ">
            <![CDATA[ AND stores_id = #{stores_id} ]]>
        </if>
        ) temp
        group by stores_id,task_order_phone,task_order_name
        with rollup
        having GROUPING(stores_id) = 1 or GROUPING(stores_id) = 0 and task_order_name is not null
    </select>

    <select id="orderOnTimeCheck1"  parameterType="Map" resultType="HashMap">
        select
        create_date createDate,
        order_no orderNo,
        order_id orderId,
        fromin formin,
        brand_id brandId,
        receiver_name receiverName,
        receiver_adress receiverAdress,
        pack_user_name packUserName,
        DATEDIFF(minute,create_date,pack_user_time) packUserTime,
        DATEDIFF(minute,pack_user_time,task_time) takeSendTime,
        task_user_name taskUserName,
        task_user_phone taskUserPhone,
        task_user_time taskUserTime,
        task_order_name taskOrderName,
        task_order_phone taskOrderPhone,
        task_order_time taskOrderTime,
        task_time taskTime,
        DATEDIFF(minute,create_date,task_time) sendTime
        from
        (
        select * from [dbo].[cds_order_info]
        where
        order_status = 4
        <if test="formInfo.stores_id != null and formInfo.stores_id != '' ">
            <![CDATA[ and stores_id = #{formInfo.stores_id}  ]]>
        </if>
        <![CDATA[
            and create_date >= #{formInfo.create_date}
            and create_date <= #{formInfo.create_date}+' 23:59:59'
          ]]>
        and send_name = #{formInfo.send_name}
        <if test="formInfo.sendType==2">
            <![CDATA[
            and DATEDIFF(minute,create_date,task_time) >= 60
            ]]>
        </if>
        <if test="formInfo.sendType==3">
            <![CDATA[
            and DATEDIFF(minute,create_date,task_time) < 60
            ]]>
        </if>
        and service_time is null
        union ALL
        select * from [dbo].[view_cds_order_info]
        where
        order_status = 4
        <if test="formInfo.stores_id != null and formInfo.stores_id != '' ">
            <![CDATA[ and stores_id = #{formInfo.stores_id}  ]]>
        </if>
        <![CDATA[
            and create_date >= #{formInfo.create_date}
            and create_date <= #{formInfo.create_date}+' 23:59:59'
          ]]>
        and send_name = #{formInfo.send_name}
        <if test="formInfo.sendType==2">
            <![CDATA[
            and DATEDIFF(minute,create_date,task_time) >= 60
            ]]>
        </if>
        <if test="formInfo.sendType==3">
            <![CDATA[
            and DATEDIFF(minute,create_date,task_time) < 60
            ]]>
        </if>
        and service_time is null
        ) temp
    </select>

    <select id="orderOnTimeCheck2"  parameterType="Map" resultType="HashMap">
        select
        create_date createDate,
        order_no orderNo,
        order_id orderId,
        fromin formin,
        brand_id brandId,
        receiver_name receiverName,
        receiver_adress receiverAdress,
        pack_user_name packUserName,
        DATEDIFF(minute,create_date,pack_user_time) packUserTime,
        DATEDIFF(minute,service_time,task_time) takeSendTime,
        task_user_name taskUserName,
        task_user_phone taskUserPhone,
        task_user_time taskUserTime,
        task_order_name taskOrderName,
        task_order_phone taskOrderPhone,
        task_order_time taskOrderTime,
        task_time taskTime,
        service_time serviceTime,
        DATEDIFF(minute,task_time,service_time) sendTime
        from
        (
        select * from [dbo].[cds_order_info]
        where
        order_status = 4
        <if test="formInfo.stores_id != null and formInfo.stores_id != '' ">
            <![CDATA[ and stores_id = #{formInfo.stores_id}  ]]>
        </if>
        <![CDATA[
            and create_date >= #{formInfo.create_date}
            and create_date <= #{formInfo.create_date}+' 23:59:59'
          ]]>
        and send_name = #{formInfo.send_name}
        <if test="formInfo.sendType==2">
            <![CDATA[
            and (DATEDIFF(minute,service_time,task_time) < -10 or DATEDIFF(minute,service_time,task_time) > 10)
            ]]>
        </if>
        <if test="formInfo.sendType==3">
            <![CDATA[
            and (DATEDIFF(minute,service_time,task_time) >= -10 and DATEDIFF(minute,service_time,task_time) <= 10)
            ]]>
        </if>
        and service_time is not null
        union ALL
        select * from [dbo].[view_cds_order_info]
        where
        order_status = 4
        <if test="formInfo.stores_id != null and formInfo.stores_id != '' ">
            <![CDATA[ and stores_id = #{formInfo.stores_id}  ]]>
        </if>
        <![CDATA[
            and create_date >= #{formInfo.create_date}
            and create_date <= #{formInfo.create_date}+' 23:59:59'
          ]]>
        and send_name = #{formInfo.send_name}
        <if test="formInfo.sendType==2">
            <![CDATA[
            and (DATEDIFF(minute,service_time,task_time) < -10 or DATEDIFF(minute,service_time,task_time) > 10)
            ]]>
        </if>
        <if test="formInfo.sendType==3">
            <![CDATA[
            and (DATEDIFF(minute,service_time,task_time) >= -10 and DATEDIFF(minute,service_time,task_time) <= 10)
            ]]>
        </if>
        and service_time is not null
        ) temp
    </select>

    <select id="orderRiderCheck1"  parameterType="Map" resultType="HashMap">
        select
        create_date createDate,
        order_no orderNo,
        order_id orderId,
        fromin formin,
        brand_id brandId,
        receiver_name receiverName,
        receiver_adress receiverAdress,
        pack_user_name packUserName,
        DATEDIFF(minute,create_date,pack_user_time) packUserTime,
        DATEDIFF(minute,pack_user_time,task_time) takeSendTime,
        task_user_name taskUserName,
        task_user_phone taskUserPhone,
        task_user_time taskUserTime,
        task_order_name taskOrderName,
        task_order_phone taskOrderPhone,
        task_order_time taskOrderTime,
        task_time taskTime,
        DATEDIFF(minute,create_date,task_time) sendTime
        from
        (
        select * from [dbo].[cds_order_info]
        where
        order_status = 4
        <![CDATA[
            and create_date >= #{formInfo.startday}
            and create_date <= #{formInfo.endday}+' 23:59:59'
          ]]>
        <if test="formInfo.sendType==2">
            <![CDATA[
            and DATEDIFF(minute,create_date,task_time) >= 60
            ]]>
        </if>
        <if test="formInfo.sendType==3">
            <![CDATA[
            and DATEDIFF(minute,create_date,task_time) < 60
            ]]>
        </if>
        and task_order_name = #{formInfo.taskOrderName}
        and service_time is null
        union ALL
        select * from [dbo].[view_cds_order_info]
        where
        order_status = 4
        <![CDATA[
            and create_date >= #{formInfo.startday}
            and create_date <= #{formInfo.endday}+' 23:59:59'
          ]]>
        <if test="formInfo.sendType==2">
            <![CDATA[
            and DATEDIFF(minute,create_date,task_time) >= 60
            ]]>
        </if>
        <if test="formInfo.sendType==3">
            <![CDATA[
            and DATEDIFF(minute,create_date,task_time) < 60
            ]]>
        </if>
        and task_order_name = #{formInfo.taskOrderName}
        and service_time is null
        ) temp
    </select>

    <select id="orderRiderCheck2"  parameterType="Map" resultType="HashMap">
        select
        create_date createDate,
        order_no orderNo,
        order_id orderId,
        fromin formin,
        brand_id brandId,
        receiver_name receiverName,
        receiver_adress receiverAdress,
        pack_user_name packUserName,
        DATEDIFF(minute,create_date,pack_user_time) packUserTime,
        DATEDIFF(minute,service_time,task_time) takeSendTime,
        task_user_name taskUserName,
        task_user_phone taskUserPhone,
        task_user_time taskUserTime,
        task_order_name taskOrderName,
        task_order_phone taskOrderPhone,
        task_order_time taskOrderTime,
        task_time taskTime,
        service_time serviceTime,
        DATEDIFF(minute,task_time,service_time) sendTime
        from
        (
        select * from [dbo].[cds_order_info]
        where
        order_status = 4
        and task_order_name = #{formInfo.taskOrderName}
        <![CDATA[
            and create_date >= #{formInfo.startday}
            and create_date <= #{formInfo.endday}+' 23:59:59'
          ]]>
        <if test="formInfo.sendType==2">
            <![CDATA[
            and (DATEDIFF(minute,service_time,task_time) < -10 or DATEDIFF(minute,service_time,task_time) > 10)
            ]]>
        </if>
        <if test="formInfo.sendType==3">
            <![CDATA[
            and (DATEDIFF(minute,service_time,task_time) >= -10 and DATEDIFF(minute,service_time,task_time) <= 10)
            ]]>
        </if>
        and service_time is not null
        union ALL
        select * from [dbo].[view_cds_order_info]
        where
        order_status = 4
        and task_order_name = #{formInfo.taskOrderName}
        <![CDATA[
            and create_date >= #{formInfo.startday}
            and create_date <= #{formInfo.endday}+' 23:59:59'
          ]]>
        <if test="formInfo.sendType==2">
            <![CDATA[
            and (DATEDIFF(minute,service_time,task_time) < -10 or DATEDIFF(minute,service_time,task_time) > 10)
            ]]>
        </if>
        <if test="formInfo.sendType==3">
            <![CDATA[
            and (DATEDIFF(minute,service_time,task_time) >= -10 and DATEDIFF(minute,service_time,task_time) <= 10)
            ]]>
        </if>
        and service_time is not null
        ) temp
    </select>

    <!--补单，查询门店订单编号及流水号-->
    <select id="getOrderNolist" parameterType="Map" resultType="HashMap">
        <![CDATA[

            select order_desc,fromin_no
            from cds_order_info
            where create_date>#{cday}
            and create_date< #{cday} + ' 23:59:59'
            and fromin=#{fromin}
            and stores_id=#{stores_id}
            and brand_id=#{brand_id}
            order by CAST(fromin_no as int)
        ]]>
    </select>

    <select id="storesOrderCount"  parameterType="Map" resultType="HashMap">
        select
        isnull((select name from cds_stores s where s.stores_id = o.stores_id),'合计') storesName,
        (select month_income from cds_stores_income s where s.stores_id = o.stores_id and DateName(month,s.date_month) =DateName(month,#{startday})) monthIncome,
        sum(goods_prcie) goodsPrice,
        sum(income) income,
        sum(goods_prcie+ship_fee+box_price) price,
        sum(send_price) sendPrice,
        sum(shop_part) shopPart,
        sum(case when fromin='美团' then 1 else 0 end) mtOrderCount,
        sum(case when fromin='饿了么' then 1 else 0 end) elmOrderCount,
        count(1) orderCount
        from
        (
        SELECT * from cds_order_info o
        where
        order_status = 4
        <![CDATA[
            and create_date >= #{startday}
            and create_date <= #{endday}+' 23:59:59'
          ]]>
        <if test="stores_id != null and stores_id != '' ">
            <![CDATA[ AND stores_id = #{stores_id} ]]>
        </if>
        union ALL
        select * from [dbo].[view_cds_order_info]
        where
        order_status = 4
        <![CDATA[
            and create_date >= #{startday}
            and create_date <= #{endday}+' 23:59:59'
          ]]>
        <if test="stores_id != null and stores_id != '' ">
            <![CDATA[ AND stores_id = #{stores_id} ]]>
        </if>
        ) o
        group by o.stores_id
        with rollup
    </select>

    <select id="getCdsStore" parameterType="Map" resultType="CdsStores">
        <![CDATA[

            select top 1 *
            from cds_stores
            where stores1_id like '%'+#{stores_id}+'%'
            or stores2_id like '%'+#{stores_id}+'%'
            or stores4_id like '%'+#{stores_id}+'%'

        ]]>
    </select>

    <select id="orderSelectFromin" resultType="java.lang.String">
        select fromin from cds_order_Info GROUP BY fromin
    </select>

    <select id="orderShop"  parameterType="Map" resultType="HashMap">
        select
        isnull((select name from cds_stores s where s.stores_id = o.stores_id),'合计') storesName,
        <foreach collection="list" item="item" index="i">
            sum(case when fromin=#{item} then goods_prcie+ship_fee+box_price else 0 end) price${i},
            sum(case when fromin=#{item} then shop_part else 0 end) shopPart${i},
        </foreach>
        sum(goods_prcie+ship_fee+box_price) price,
        sum(shop_part) shopPart
        from
        (
        select * from  cds_order_info
        where
        order_status = 4
        <![CDATA[
            and create_date >= #{startday}
            and create_date <= #{endday}+' 23:59:59'
          ]]>
        <if test="stores_id != null and stores_id != '' ">
            <![CDATA[ AND stores_id = #{stores_id} ]]>
        </if>
        union ALL
        select * from [dbo].[view_cds_order_info]
        where
        order_status = 4
        <![CDATA[
            and create_date >= #{startday}
            and create_date <= #{endday}+' 23:59:59'
          ]]>
        <if test="stores_id != null and stores_id != '' ">
            <![CDATA[ AND stores_id = #{stores_id} ]]>
        </if>
        ) o
        group by stores_id
        with rollup
    </select>

</mapper>