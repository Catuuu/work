<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC
        "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cds_stores_order_info">

    <!--查询预订单、待打包、待取餐数量-->
    <select id="getOrderCount" parameterType="HashMap" resultType="HashMap">
        <![CDATA[
            select
            isnull(sum(case when o.pack_user_time is null and o.service_time is not null then 1 else 0 end ),0) count3,
            isnull(sum(case when o.pack_user_time is null and o.service_time is null then 1 else 0 end ),0) count1,
            isnull(sum(case when o.pack_user_time is not null then 1 else 0 end ),0) count2
            from cds_order_info o
            left join cds_stores s on o.stores_id = s.stores_id
            where o.create_date > CONVERT(varchar(100), GETDATE(), 23)
            and o.stores_id = #{stores_id}
            and (o.order_status = 1 or o.order_status = 2)
         ]]>
    </select>


    <!--店铺出餐订单列表查询-->
    <select id="getStoresPageRecord" parameterType="HashMap" resultType="Map">
        <![CDATA[
            select * from (select top 200 * from view_pack_cds_order_info o where o.stores_id=#{stores_id}  and mtype=1 order by timeout ) temp
            union all
            select * from (select top 200 * from view_pack_cds_order_info o where o.stores_id=#{stores_id}  and mtype=2 order by timeout ) temp
            union all
            select * from (select top 200 * from view_pack_cds_order_info o where o.stores_id=#{stores_id}  and mtype=3 order by timeout ) temp
        ]]>
    </select>



    <!--打印同步-->
    <update id="syncPrints" parameterType="java.util.List">
         update cds_order_info SET isstoresprint = 1, print_time = getDate() WHERE order_id in
        <foreach collection="list" item="item" index="index" open="(" separator="," close=")">
            #{item.order_id}
        </foreach>
    </update>

    <!--查询扫码所有同步订单-->
    <select id="getAllOrders" parameterType="java.util.List" resultType="HashMap">
        SELECT
        o.order_id,
        o.send_name,
        o.is_sync,
        o.fromin,
        o.order_desc,
        o.pack_user_time,
        o.order_type,
        o.order_status
        FROM cds_order_info o
        WHERE o.order_id IN
        <foreach collection="list" item="item" index="index" open="(" separator="," close=")">
            #{item.order_id}
        </foreach>
    </select>

    <!--修改点我达骑手订单或微信堂食堂订单表扫码数据-->
    <update id="updateWX" parameterType="java.util.List">
        update cds_order_info set
        order_status =
        <foreach collection="list" item="item" index="index" separator=" " open="case order_id" close="end">
            when #{item.order_id} then #{item.order_status}
        </foreach>
        ,pack_user_id =
        <foreach collection="list" item="item" index="index" separator=" " open="case order_id" close="end">
            when #{item.order_id} then #{item.pack_user_id}
        </foreach>
        ,pack_user_time =
        <foreach collection="list" item="item" index="index" separator=" " open="case order_id" close="end">
            when #{item.order_id} then #{item.pack_time,jdbcType=DATE}
        </foreach>
        ,pack_user_name =
        <foreach collection="list" item="item" index="index" separator=" " open="case order_id" close="end">
            when #{item.order_id} then #{item.pack_user_name}
        </foreach>
        where order_id in
        <foreach collection="list" index="index" item="item" separator="," open="(" close=")">
            #{item.order_id}
        </foreach>
    </update>

    <!--修改正常订单表扫码数据-->
    <update id="updateOrderInfo" parameterType="java.util.List">
        update cds_order_info set
        pack_user_id =
        <foreach collection="list" item="item" index="index" separator=" " open="case order_id" close="end">
            when #{item.order_id} then #{item.pack_user_id}
        </foreach>
        ,pack_user_time =
        <foreach collection="list" item="item" index="index" separator=" " open="case order_id" close="end">
            when #{item.order_id} then #{item.pack_time,jdbcType=DATE}
        </foreach>
        ,pack_user_name =
        <foreach collection="list" item="item" index="index" separator=" " open="case order_id" close="end">
            when #{item.order_id} then #{item.pack_user_name}
        </foreach>
        where order_id in
        <foreach collection="list" index="index" item="item" separator="," open="(" close=")">
            #{item.order_id}
        </foreach>
    </update>




    <update id="updateOrderAll" parameterType="Map">
        <!--修改点我达骑手订单或微信堂食堂订单表扫码数据-->
        <foreach collection="finsh_orders" item="item" index="" separator="" open="" close="">
            update cds_order_info set  order_status =#{item.order_status} ,pack_user_id = #{item.pack_user_id},pack_user_time = #{item.pack_time,jdbcType=DATE} ,pack_user_name = #{item.pack_user_name} where order_id = #{item.order_id};
        </foreach>
        <!--修改正常订单表扫码数据-->
        <foreach collection="normal_orders" item="item" index="" separator="" open="" close="">
            update cds_order_info set pack_user_id = #{item.pack_user_id},pack_user_time = #{item.pack_time,jdbcType=DATE} ,pack_user_name = #{item.pack_user_name} where order_id = #{item.order_id};
        </foreach>
    </update>




    <!--根据订单号查询出餐机-->
    <select id="getMealByOrderId" parameterType="String" resultType="Integer">
        select top 1 cmg.cm_id from cds_chufan_meal_goods cmg
        left join cds_ms_goods_list mgl
        on cmg.good_id = mgl.good_id
        where mgl.order_id = #{order_id}
    </select>

    <!--分页查询erp所有菜品-->
    <select id="searchGoods" parameterType="HashMap" resultType="HashMap">
        SELECT
            tmp.*
        FROM
            (
                SELECT
                    (
                        row_number () OVER (ORDER BY mg.good_id DESC)
                    ) AS rownumber,
                    (
                        SELECT
                            COUNT (*)
                        FROM
                            cds_chufan_meal cm
                        LEFT JOIN cds_chufan_meal_goods cmg ON cmg.cm_id = cm.cm_id
                        WHERE
                            cm.stores_id = #{stores_id}
                        AND mg.good_id = cmg.good_id
                    ) AS type,
                    mg.good_id,
                    mg.class_id,
                    mg.good_num,
                    mg.status,
                    mg.good_name,
                    mg.out_time,
                    mg.pinxin,
                    mg.good_price,
                    mg.uptime,
                    mg.good_key
                FROM
                    cds_ms_goods mg
                WHERE
                    mg.status = 1

            ) tmp
        WHERE
            tmp.rownumber BETWEEN #{num1}
        AND #{num2}
    </select>
    <!--查询erp分页总数-->
    <select id="getErpPageCount" resultType="Integer">
      SELECT count(*) FROM cds_ms_goods mg WHERE mg.status = 1
    </select>


    <!--检查erp商品是否已被出餐机添加-->
    <select id="checkErpGoods" parameterType="HashMap" resultType="HashMap">
        select cm.cm_id
        from cds_chufan_meal cm
        left join cds_chufan_meal_goods cmg on cmg.cm_id = cm.cm_id
        where  cm.stores_id = #{stores_id} and cm.cm_id = #{cm_id} and cmg.good_id = #{good_id}
    </select>


    <select id="getAllOrdersId" parameterType="Map" resultType="HashMap">
        select order_id
        from cds_order_info
        where stores_id = #{stores_id}
        and create_date>CONVERT(varchar(100), GETDATE(), 23)
        order by order_no
    </select>

    <select id="getAllOrdersInfo" parameterType="java.util.List" resultType="CdsOrderInfo">
        select *
        from cds_order_info
        where order_id in
        <foreach collection="list" index="index" item="item" separator="," open="(" close=")">
            #{item.order_id}
        </foreach>
    </select>

</mapper>