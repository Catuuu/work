<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC
        "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cds_backmoney">
    <!--退款列表分页数据查询-->
    <select id="getPageRecord" parameterType="PageParam" resultType="HashMap">
        <![CDATA[
            select * from (
            select
            DATEDIFF(minute,o.create_date,o.pack_user_time)   as pack_time,
            DATEDIFF(minute,o.create_date,getdate()) as pack_wait_time,
            DATEDIFF(minute,isnull(o.pack_user_time,o.create_date),o.task_user_time) as takemea_time,
            DATEDIFF(minute,isnull(o.pack_user_time,o.create_date),getdate()) as takemea_wait_time,
            DATEDIFF(minute,isnull(isnull(o.task_user_time,o.pack_user_time),o.create_date),o.task_time) as use_send_time,
            DATEDIFF(minute,isnull(isnull(o.task_user_time,o.pack_user_time),o.create_date),getdate()) as use_send_wait_time,
            s.name stores_name,
            b.brand_name,
            o.fromin,
            o.fromin_no,
            o.order_no,
            o.order_desc,
            o.cancel_remark,
            o.cancel_type,
            o.order_status,
            o.task_user_name,
            o.task_order_phone,
            bm.*
            from cds_back_money bm
            left join cds_order_info o on o.order_id = bm.order_id
            left join cds_stores s on o.stores_id = s.stores_id
            left join cds_brand b on o.brand_id = b.brand_id

        ]]>
        <where>
            <if test="formInfo.sl_date_begin != null and formInfo.sl_date_begin != '' ">
                <![CDATA[ bm.bp_time >= #{formInfo.sl_date_begin} ]]>
            </if>
            <if test="formInfo.sl_date_end != null and formInfo.sl_date_end != '' ">
                <![CDATA[ AND bm.bp_time <= #{formInfo.sl_date_end} + ' 23:59:59'  ]]>
            </if>
            <if test="formInfo.stores_id != null and formInfo.stores_id != '' ">
                <![CDATA[ AND o.stores_id = #{formInfo.stores_id} ]]>
            </if>
            <if test="formInfo.brand_id != null and formInfo.brand_id != '' and formInfo.brand_id != 0">
                <![CDATA[ AND o.brand_id = #{formInfo.brand_id} ]]>
            </if>
            <if test="formInfo.back_status !=null and formInfo.back_status != '' and formInfo.back_status !=2">
                <![CDATA[ AND bm.back_status = #{formInfo.back_status} ]]>
            </if>
            <if test="formInfo.back_status !=null and formInfo.back_status ==2">
                <![CDATA[ AND bm.back_status in (2,6,7) ]]>
            </if>
            <!--<if test="formInfo.do_status !=null and formInfo.do_status != ''">-->
                <!--<![CDATA[ AND bm.do_status = #{formInfo.do_status} ]]>-->
            <!--</if>-->
            <if test="formInfo.do_status !=null and formInfo.do_status == 1">
                <![CDATA[ AND bm.do_status = #{formInfo.do_status} ]]>
            </if>
            <if test="formInfo.do_status !=null and formInfo.do_status == 0">
                <![CDATA[ AND (bm.do_status = #{formInfo.do_status} or bm.do_status is null )]]>
            </if>
            <if test="formInfo.keywords != null and formInfo.keywords != '' ">
                <![CDATA[
                    AND (
                        o.order_id LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.order_no LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.order_desc LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.fromin_no LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.receiver_name LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.receiver_phone LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.receiver_adress LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.task_user_name LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.task_user_phone LIKE '%'+#{formInfo.keywords}+'%'
                      )
                ]]>
            </if>
            <choose>
                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "0"'>
                    AND (o.fromin = '饿了么' or o.fromin = '美团')
                </when>
                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "1"'>
                    AND o.fromin = '饿了么'
                </when>
                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "2"'>
                    AND o.fromin = '美团'
                </when>
                <otherwise>

                </otherwise>
            </choose>
        </where>

        union all

        <![CDATA[
        select
        DATEDIFF(minute,o.create_date,o.pack_user_time)   as pack_time,
        DATEDIFF(minute,o.create_date,getdate()) as pack_wait_time,
        DATEDIFF(minute,isnull(o.pack_user_time,o.create_date),o.task_user_time) as takemea_time,
        DATEDIFF(minute,isnull(o.pack_user_time,o.create_date),getdate()) as takemea_wait_time,
        DATEDIFF(minute,isnull(isnull(o.task_user_time,o.pack_user_time),o.create_date),o.task_time) as use_send_time,
        DATEDIFF(minute,isnull(isnull(o.task_user_time,o.pack_user_time),o.create_date),getdate()) as use_send_wait_time,
        s.name stores_name,
        b.brand_name,
        o.fromin,
        o.fromin_no,
        o.order_no,
        o.order_desc,
        o.cancel_remark,
        o.cancel_type,
        o.order_status,
        o.task_user_name,
        o.task_order_phone,
        bm.*
        from cds_back_money bm
        left join view_cds_order_info o on o.order_id = bm.order_id
        left join cds_stores s on o.stores_id = s.stores_id
        left join cds_brand b on o.brand_id = b.brand_id

        ]]>
        <where>
            <if test="formInfo.sl_date_begin != null and formInfo.sl_date_begin != '' ">
                <![CDATA[ bm.bp_time >= #{formInfo.sl_date_begin} ]]>
            </if>
            <if test="formInfo.sl_date_end != null and formInfo.sl_date_end != '' ">
                <![CDATA[ AND bm.bp_time <= #{formInfo.sl_date_end} + ' 23:59:59'  ]]>
            </if>
            <if test="formInfo.stores_id != null and formInfo.stores_id != '' ">
                <![CDATA[ AND o.stores_id = #{formInfo.stores_id} ]]>
            </if>
            <if test="formInfo.brand_id != null and formInfo.brand_id != '' and formInfo.brand_id != 0">
                <![CDATA[ AND o.brand_id = #{formInfo.brand_id} ]]>
            </if>
            <if test="formInfo.back_status !=null and formInfo.back_status != '' and formInfo.back_status !=2">
                <![CDATA[ AND bm.back_status = #{formInfo.back_status} ]]>
            </if>
            <if test="formInfo.back_status !=null and formInfo.back_status == 2">
                <![CDATA[ AND bm.back_status in (2,6,7) ]]>
            </if>
            <!--<if test="formInfo.do_status !=null and formInfo.do_status != ''">-->
            <!--<![CDATA[ AND bm.do_status = #{formInfo.do_status} ]]>-->
            <!--</if>-->
            <if test="formInfo.do_status !=null and formInfo.do_status == 1">
                <![CDATA[ AND bm.do_status = #{formInfo.do_status} ]]>
            </if>
            <if test="formInfo.do_status !=null and formInfo.do_status == 0">
                <![CDATA[ AND (bm.do_status = #{formInfo.do_status} or bm.do_status is null )]]>
            </if>
            <if test="formInfo.keywords != null and formInfo.keywords != '' ">
                <![CDATA[
                    AND (
                        o.order_id LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.order_no LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.order_desc LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.fromin_no LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.receiver_name LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.receiver_phone LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.receiver_adress LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.task_user_name LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.task_user_phone LIKE '%'+#{formInfo.keywords}+'%'
                      )
                ]]>
            </if>
            <choose>
                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "0"'>
                    AND (o.fromin = '饿了么' or o.fromin = '美团')
                </when>
                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "1"'>
                    AND o.fromin = '饿了么'
                </when>
                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "2"'>
                    AND o.fromin = '美团'
                </when>
                <otherwise>

                </otherwise>
            </choose>
        </where>
        ) temp

    </select>

    <!--历史退款列表分页数据查询-->
    <select id="getHistoryPageRecord" parameterType="PageParam" resultType="HashMap">
        <![CDATA[
            select
            DATEDIFF(minute,o.create_date,o.pack_user_time)   as pack_time,
            DATEDIFF(minute,o.create_date,getdate()) as pack_wait_time,
            DATEDIFF(minute,isnull(o.pack_user_time,o.create_date),o.task_user_time) as takemea_time,
            DATEDIFF(minute,isnull(o.pack_user_time,o.create_date),getdate()) as takemea_wait_time,
            DATEDIFF(minute,isnull(isnull(o.task_user_time,o.pack_user_time),o.create_date),o.task_time) as use_send_time,
            DATEDIFF(minute,isnull(isnull(o.task_user_time,o.pack_user_time),o.create_date),getdate()) as use_send_wait_time,
            s.name stores_name,
            b.brand_name,
            o.fromin,
            o.fromin_no,
            o.order_no,
            o.order_desc,
            o.cancel_remark,
            o.cancel_type,
            o.order_status,
            bm.*
            from cds_back_money bm
--             left join cds_order_info o on o.order_id = bm.order_id
            left join view_cds_order_info o on o.order_id = bm.order_id
            left join cds_stores s on o.stores_id = s.stores_id
            left join cds_brand b on o.brand_id = b.brand_id

        ]]>
        <where>
            <if test="formInfo.sl_date_begin != null and formInfo.sl_date_begin != '' ">
                <![CDATA[ bm.bp_time >= #{formInfo.sl_date_begin} ]]>
            </if>
            <if test="formInfo.sl_date_end != null and formInfo.sl_date_end != '' ">
                <![CDATA[ AND bm.bp_time <= #{formInfo.sl_date_end} + ' 23:59:59'  ]]>
            </if>
            <if test="formInfo.stores_id != null and formInfo.stores_id != '' ">
                <![CDATA[ AND o.stores_id = #{formInfo.stores_id} ]]>
            </if>
            <if test="formInfo.brand_id != null and formInfo.brand_id != '' and formInfo.brand_id != 0">
                <![CDATA[ AND o.brand_id = #{formInfo.brand_id} ]]>
            </if>
            <if test="formInfo.back_status !=null and formInfo.back_status != ''">
                <![CDATA[ AND bm.back_status = #{formInfo.back_status} ]]>
            </if>
            <if test="formInfo.do_status !=null and formInfo.do_status != ''">
                <![CDATA[ AND bm.do_status = #{formInfo.do_status} ]]>
            </if>
            <if test="formInfo.keywords != null and formInfo.keywords != '' ">
                <![CDATA[
                    AND (
                        o.order_id LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.order_no LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.order_desc LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.fromin_no LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.receiver_name LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.receiver_phone LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.receiver_adress LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.task_user_name LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.task_user_phone LIKE '%'+#{formInfo.keywords}+'%'
                      )
                ]]>
            </if>
            <choose>
                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "0"'>
                    AND (o.fromin = '饿了么' or o.fromin = '美团')
                </when>
                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "1"'>
                    AND o.fromin = '饿了么'
                </when>
                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "2"'>
                    AND o.fromin = '美团'
                </when>
                <otherwise>

                </otherwise>
            </choose>
        </where>

    </select>

    <select id="orderInfo" parameterType="CdsOrderInfo" resultType="CdsOrderInfo">
        select * from cds_order_info where order_id = #{order_id}
            UNION ALL
             select * from view_cds_order_info where order_id = #{order_id}
    </select>

    <!--轮询退款申请-->
    <select id="bmCount" parameterType="HashMap" resultType="HashMap">
        select isnull(count(1),0) as bm_count from cds_back_money where bp_time >= #{sl_date_begin}
         <![CDATA[ AND bp_time <= #{sl_date_end} + ' 23:59:59'  ]]>
        and (do_status = 0 or do_status is null)
    </select>
    <!--门店轮询退款申请-->
    <select id="shop_bmCount" parameterType="HashMap" resultType="HashMap">
        select isnull(count(1),0) as bm_count from cds_back_money where bp_time >= #{sl_date_begin}
        <![CDATA[ AND bp_time <= #{sl_date_end} + ' 23:59:59'  ]]>
        and (do_status = 0 or do_status is null)
        <if test="formInfo.stores_id != null and formInfo.stores_id != '' ">
            <![CDATA[ AND stores_id = #{formInfo.stores_id} ]]>
        </if>

    </select>

</mapper>