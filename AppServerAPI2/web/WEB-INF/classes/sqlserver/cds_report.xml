<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC
        "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cds_report">
    <!--用户统计-->
    <select id="report1" parameterType="Map" resultType="HashMap">
        <![CDATA[
            select * from cds_member_report
        ]]>
        <where>
            <if test="startday != null and startday != '' ">
                <![CDATA[ AND report_time >= #{startday} ]]>
            </if>
            <if test="endday != null and endday != '' ">
                <![CDATA[ AND report_time <= #{endday} + ' 23:59:59'  ]]>
            </if>
        </where>
        <![CDATA[
            and stores_id = #{stores_id}
            and brand_id = #{brand_id}
            order by report_time
         ]]>
    </select>


    <!--出餐率统计-->
    <select id="report2" parameterType="Map" resultType="HashMap">

           select * from (
                select (case when SUM(temp.iscount)>0 then
                (SUM(temp.iscount)+0.0)/SUM(1)
                else 0 end) as storescount,
                <foreach item="item" collection="list" separator="" index="index">
                    (case when SUM(case when stores_id=${item.storesId} then temp.iscount else 0 end)>0 then
                    (SUM(case when stores_id=${item.storesId} then temp.iscount else 0 end)+0.0)/SUM(case when stores_id=${item.storesId} then 1 else 0 end )
                    else 0 end) as cur_storescount${index},
                </foreach>
                isnull(order_date,'合计') as order_date
                from (
                    select
                    s.stores_id,
                    s.name stores_name,
                    DATEDIFF(minute,o.create_date,o.pack_user_time)   as pack_time,
                    CONVERT(varchar(100),o.create_date,23) as order_date,
                    (case when o.pack_user_time is null or DATEDIFF(minute,o.create_date,o.pack_user_time)>${datatype} then 0 else 1 end ) as iscount
                    from cds_order_info o
                    left join cds_stores s on o.stores_id = s.stores_id
                    where o.create_date >= #{startday}+' 00:00:00'
                            <![CDATA[AND o.create_date <= #{endday}+' 23:59:59' ]]>
                    and o.service_time is null

                    union all

                   select
                    s.stores_id,
                    s.name stores_name,
                    DATEDIFF(minute,o.create_date,o.pack_user_time)   as pack_time,
                    CONVERT(varchar(100),o.create_date,23) as order_date,
                    (case when o.pack_user_time is null or DATEDIFF(minute,o.create_date,o.pack_user_time)>${datatype} then 0 else 1 end ) as iscount
                    from view_cds_order_info o
                    left join cds_stores s on o.stores_id = s.stores_id
                    where o.create_date >= #{startday}+' 00:00:00'
                           <![CDATA[AND o.create_date <= #{endday}+' 23:59:59']]>
                    and o.service_time is null
                ) temp
                group by temp.order_date
                with cube) t order by t.order_date

    </select>


</mapper>