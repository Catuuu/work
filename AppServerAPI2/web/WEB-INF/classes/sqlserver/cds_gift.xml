<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC
        "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cds_gift">
    <!--订单分页数据查询-->
    <select id="getPageRecord" parameterType="PageParam" resultType="HashMap">
        <![CDATA[
            select
            DATEDIFF(minute,o.create_date,o.pack_user_time)   as pack_time,
            DATEDIFF(minute,o.create_date,getdate()) as pack_wait_time,
            DATEDIFF(minute,isnull(o.pack_user_time,o.create_date),o.task_user_time) as takemea_time,
            DATEDIFF(minute,isnull(o.pack_user_time,o.create_date),getdate()) as takemea_wait_time,
            DATEDIFF(minute,isnull(o.task_order_time,o.create_date),o.task_time) as use_send_time,
            DATEDIFF(minute,isnull(isnull(o.task_user_time,o.pack_user_time),o.create_date),getdate()) as use_send_wait_time,
            s.name stores_name,
            b.brand_name,
            o.*
--             isnull(g.send_type,99) as send_type
            from cds_order_info o
            left join cds_stores s on o.stores_id = s.stores_id
            left join cds_brand b on o.brand_id = b.brand_id
--             left join cds_gift_register_list g on g.phone = o.receiver_phone
        ]]>
        <where>
            <if test="formInfo.sl_date_begin != null and formInfo.sl_date_begin != '' ">
                <![CDATA[ o.create_date >= #{formInfo.sl_date_begin} ]]>
            </if>
            <if test="formInfo.sl_date_end != null and formInfo.sl_date_end != '' ">
                <![CDATA[ AND o.create_date <= #{formInfo.sl_date_end} + ' 23:59:59'  ]]>
            </if>
            <if test="formInfo.isprint != null and formInfo.isprint != '' ">
                <![CDATA[ AND o.isstoresprint = #{formInfo.isprint} ]]>
            </if>
            <if test="formInfo.order_type != null and formInfo.order_type != '' ">
                <![CDATA[ AND o.order_type = #{formInfo.order_type} ]]>
            </if>
            <if test="formInfo.send_name != null and formInfo.send_name != '' ">
                <![CDATA[ AND o.send_name = #{formInfo.send_name} ]]>
            </if>
            <if test="formInfo.stores_id != null and formInfo.stores_id != '' ">
                <![CDATA[ AND o.stores_id = #{formInfo.stores_id} ]]>
            </if>
            <if test="formInfo.pay_type_id != null and formInfo.pay_type_id != '' ">
                <![CDATA[ AND o.pay_type_id = #{formInfo.pay_type_id} ]]>
            </if>
            <if test="formInfo.brand_id != null and formInfo.brand_id != '' and formInfo.brand_id != 0">
                <![CDATA[ AND o.brand_id = #{formInfo.brand_id} ]]>
            </if>
            <if test="formInfo.keywords != null and formInfo.keywords != '' ">
                <![CDATA[
                    AND (
                        o.order_id LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.order_no LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.order_desc LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.fromin_no LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.receiver_name LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.receiver_phone LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.receiver_adress LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.task_user_name LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.task_user_phone LIKE '%'+#{formInfo.keywords}+'%'
                      )
                ]]>
            </if>
            <if test="formInfo.fromin_no != null and formInfo.fromin_no != ''">
                <![CDATA[ AND o.fromin_no LIKE #{formInfo.fromin_no} ]]>
            </if>
            <if test='formInfo.remark != null and formInfo.remark =="1"'>
                <![CDATA[ AND o.member_desc is not null and o.member_desc !='']]>
            </if>
            <if test='formInfo.remark != null and formInfo.remark =="2"'>
                <![CDATA[ AND (o.member_desc is null or o.member_desc = '')]]>
            </if>
            <choose>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "1"'>
                    AND o.order_status = 0
                </when>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "2"'>
                    AND (o.order_status = 1 or o.order_status = 2) and o.pack_user_time is null
                </when>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "3"'>
                    AND (o.order_status = 1 or o.order_status = 2) and o.pack_user_time is not null
                </when>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "4"'>
                    AND o.order_status = 3
                </when>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "5"'>
                    AND o.order_status = 4
                </when>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "6"'>
                    AND o.order_status = 99
                </when>
                <otherwise>

                </otherwise>
            </choose>
            <choose>
                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "1"'>
                    AND o.fromin = '饿了么'
                </when>
                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "2"'>
                    AND o.fromin = '美团'
                </when>
                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "3"'>
                    AND o.fromin = '百度外卖'
                </when>

                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "4"'>
                    AND o.fromin = '微信'
                </when>
            </choose>
        </where>

    </select>

    <!--历史-->
    <select id="getHistoryPageRecord" parameterType="PageParam" resultType="HashMap">
        <![CDATA[
            select
            DATEDIFF(minute,o.create_date,o.pack_user_time)   as pack_time,
            DATEDIFF(minute,o.create_date,getdate()) as pack_wait_time,
            DATEDIFF(minute,isnull(o.pack_user_time,o.create_date),o.task_user_time) as takemea_time,
            DATEDIFF(minute,isnull(o.pack_user_time,o.create_date),getdate()) as takemea_wait_time,
            DATEDIFF(minute,isnull(o.task_order_time,o.create_date),o.task_time) as use_send_time,
            DATEDIFF(minute,isnull(isnull(o.task_user_time,o.pack_user_time),o.create_date),getdate()) as use_send_wait_time,
            s.name stores_name,
            b.brand_name,
            o.*
--             isnull(g.send_type,99) as send_type
            from view_cds_order_info o
            left join cds_stores s on o.stores_id = s.stores_id
            left join cds_brand b on o.brand_id = b.brand_id
--             left join cds_gift_register_list g on g.phone = o.receiver_phone
        ]]>
        <where>
            <if test="formInfo.sl_date_begin != null and formInfo.sl_date_begin != '' ">
                <![CDATA[ o.create_date >= #{formInfo.sl_date_begin} ]]>
            </if>
            <if test="formInfo.sl_date_end != null and formInfo.sl_date_end != '' ">
                <![CDATA[ AND o.create_date <= #{formInfo.sl_date_end} + ' 23:59:59'  ]]>
            </if>
            <if test="formInfo.isprint != null and formInfo.isprint != '' ">
                <![CDATA[ AND o.isstoresprint = #{formInfo.isprint} ]]>
            </if>
            <if test="formInfo.order_type != null and formInfo.order_type != '' ">
                <![CDATA[ AND o.order_type = #{formInfo.order_type} ]]>
            </if>
            <if test="formInfo.send_name != null and formInfo.send_name != '' ">
                <![CDATA[ AND o.send_name = #{formInfo.send_name} ]]>
            </if>
            <if test="formInfo.stores_id != null and formInfo.stores_id != '' ">
                <![CDATA[ AND o.stores_id = #{formInfo.stores_id} ]]>
            </if>
            <if test="formInfo.pay_type_id != null and formInfo.pay_type_id != '' ">
                <![CDATA[ AND o.pay_type_id = #{formInfo.pay_type_id} ]]>
            </if>
            <if test="formInfo.brand_id != null and formInfo.brand_id != '' and formInfo.brand_id != 0">
                <![CDATA[ AND o.brand_id = #{formInfo.brand_id} ]]>
            </if>
            <if test="formInfo.keywords != null and formInfo.keywords != '' ">
                <![CDATA[
                    AND (
                        o.order_id LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.order_no LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.order_desc LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.fromin_no LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.receiver_name LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.receiver_phone LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.receiver_adress LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.task_user_name LIKE '%'+#{formInfo.keywords}+'%' OR
                        o.task_user_phone LIKE '%'+#{formInfo.keywords}+'%'
                      )
                ]]>
            </if>
            <if test="formInfo.fromin_no != null and formInfo.fromin_no != ''">
                <![CDATA[ AND o.fromin_no LIKE #{formInfo.fromin_no} ]]>
            </if>
            <if test='formInfo.remark != null and formInfo.remark =="1"'>
                <![CDATA[ AND o.member_desc is not null and o.member_desc !='']]>
            </if>
            <if test='formInfo.remark != null and formInfo.remark =="2"'>
                <![CDATA[ AND (o.member_desc is null or o.member_desc = '')]]>
            </if>

            <choose>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "1"'>
                    AND o.order_status = 0
                </when>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "2"'>
                    AND (o.order_status = 1 or o.order_status = 2) and o.pack_user_time is null
                </when>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "3"'>
                    AND (o.order_status = 1 or o.order_status = 2) and o.pack_user_time is not null
                </when>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "4"'>
                    AND o.order_status = 3
                </when>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "5"'>
                    AND o.order_status = 4
                </when>
                <when test='formInfo.cur_status !=null and formInfo.cur_status == "6"'>
                    AND o.order_status = 99
                </when>
                <otherwise>

                </otherwise>
            </choose>
            <choose>
                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "1"'>
                    AND o.fromin = '饿了么'
                </when>
                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "2"'>
                    AND o.fromin = '美团'
                </when>
                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "3"'>
                    AND o.fromin = '百度外卖'
                </when>

                <when test='formInfo.cur_fromin !=null and formInfo.cur_fromin == "4"'>
                    AND o.fromin = '微信'
                </when>
            </choose>
        </where>

    </select>

    <select id="orderInfo" parameterType="CdsOrderInfo" resultType="CdsOrderInfo">
        select * from cds_order_info where order_id = #{order_id}
            UNION ALL
             select * from view_cds_order_info where order_id = #{order_id}
    </select>


    <!--赠品分页数据查询-->
    <select id="getGiftPageRecord" parameterType="PageParam" resultType="HashMap">
        <![CDATA[
            select * from cds_gift_register_list g
        ]]>
        <where>
            <if test="formInfo.sl_date_begin != null and formInfo.sl_date_begin != '' ">
                <![CDATA[ g.create_time >= #{formInfo.sl_date_begin} ]]>
            </if>
            <if test="formInfo.sl_date_end != null and formInfo.sl_date_end != '' ">
                <![CDATA[ AND g.create_time <= #{formInfo.sl_date_end} + ' 23:59:59'  ]]>
            </if>
            <if test="formInfo.send_type != null and formInfo.send_type != '' ">
                <![CDATA[ AND g.send_type = #{formInfo.send_type} ]]>
            </if>
            <if test="formInfo.send_reason != null and formInfo.send_reason != 0 ">
                <![CDATA[ AND g.send_reason = #{formInfo.send_reason} ]]>
            </if>
            <if test="formInfo.brand_id != null and formInfo.brand_id != '' and formInfo.brand_id != 0">
                <![CDATA[ AND g.brand_id = #{formInfo.brand_id} ]]>
            </if>
            <if test="formInfo.opt_type != null and formInfo.opt_type != '' ">
                <![CDATA[ AND g.opt_type = #{formInfo.opt_type} ]]>
            </if>
            <if test="formInfo.stores_id != null and formInfo.stores_id != '' ">
                <![CDATA[ AND g.stores_id = #{formInfo.stores_id} ]]>
            </if>
            <if test="formInfo.is_check != null and formInfo.is_check != '' ">
                <![CDATA[ AND g.is_check = #{formInfo.is_check} ]]>
            </if>
            <if test="formInfo.keywords != null and formInfo.keywords != '' ">
                <![CDATA[
                    AND (
                        g.order_id LIKE '%'+#{formInfo.keywords}+'%' OR
                        g.name LIKE '%'+#{formInfo.keywords}+'%' OR
                        g.phone LIKE '%'+#{formInfo.keywords}+'%'
                      )
                ]]>
            </if>
        </where>

    </select>


    <!--获取商品信息tree-->
    <select id="getTreeGoods" resultType="HashMap">
        <![CDATA[



      select
        b.brand_id as id,
        b.brand_name as name,
        'closed' as state,
                (select
                '{"id":"' + CAST (class_id AS VARCHAR(20)) + '","name":"' + CAST (class_name AS VARCHAR(20)) + '","state":"closed","children":['+CAST(goods AS VARCHAR(4000))+']},'
                from

                        (SELECT
                            c.class_id,
                            c.class_name,
                            c.brand_id,
                                    (
                                        SELECT
                                            '{"id":"' + CAST (gi.good_id AS VARCHAR(20)) + '","name":"' + CAST (gi.good_name AS VARCHAR(20)) + '"},'
                                        FROM
                                            cds_goods_info gi
                                        WHERE
                                            gi.class_id = c.class_id FOR xml path ('')
                                    ) AS goods
                        FROM cds_class c) temp

                WHERE
                temp.brand_id = b.brand_id FOR xml path ('')) as children
        from cds_brand b



        ]]>
    </select>


    <!--获取商品信息table分页-->
    <select id="getTableGoods" parameterType="PageParam" resultType="HashMap">
        <![CDATA[
          select
           gi.good_name,
           gi.good_id,
           gi.status,
           gi.market_price,
           c.brand_id,
           c.class_name,
           b.brand_name
          from cds_goods_info gi
          left join cds_class c on c.class_id = gi.class_id
          left join cds_brand b on b.brand_id = c.brand_id
           ]]>
        <where>
            <if test="formInfo.key != null">
                (gi.good_name like '%'+#{formInfo.key}+'%' or
                gi.pinxin like '%'+#{formInfo.key}+'%'
                )
            </if>
            <if test="formInfo.status != null">
                and gi.status = #{formInfo.status}
            </if>
            <if test="formInfo.class_id != null">
                and gi.class_id = #{formInfo.class_id}
            </if>
            <if test="formInfo.brand_id != null">
                and c.brand_id = #{formInfo.brand_id}
            </if>

        </where>

    </select>

    <!--cds_ms_goods  ERP商品管理列表-->
    <select id="getMsGoodsPageRecord" parameterType="PageParam" resultType="HashMap">
        <![CDATA[
            select * from  cds_ms_goods
        ]]>
        <where>
            <if test="formInfo.status != null and formInfo.status != '' ">
                <![CDATA[ status = #{formInfo.status} ]]>
            </if>
            <if test="formInfo.class_id != null and formInfo.class_id != '' ">
                <![CDATA[
                    AND (
                         class_id = #{formInfo.class_id}
                      )
                ]]>
            </if>
            <if test="formInfo.good_name != null and formInfo.good_name != '' ">
                <![CDATA[
                    AND (
                        good_name LIKE '%'+#{formInfo.good_name}+'%' OR
                        pinxin LIKE '%'+#{formInfo.good_name}+'%'
                      )
                ]]>
            </if>
            <if test="formInfo.market_price != null and formInfo.market_price != '' ">
                <![CDATA[
                     and good_price <= #{formInfo.market_price}
                ]]>
            </if>
        </where>
    </select>

    <!-- 平台商品信息列表(多规格)-->
    <select id="GetGoodsInfoLists" parameterType="PageParam" resultType="HashMap">
        <![CDATA[
        select
        sgl.sgl_id as good_id,
        sgl.good_name,
        sgl.stores_class_id as class_id,
        c.brand_id
--                 ,(select count(1) from cds_erp_good_list b where b.good_id=a.good_id) as good_count
        from cds_stores_goods_list sgl
        left join cds_stores_class c on c.stores_class_id=sgl.stores_class_id
        left join cds_standard_list sl on sl.sgl_id = sgl.sgl_id
        ]]>
        <where>
            <if test="formInfo.status != null and formInfo.status != '' ">
                <![CDATA[ sgl.status = #{formInfo.status} ]]>
            </if>
            <if test="formInfo.class_id != null and formInfo.class_id != '' ">
                <![CDATA[
                    AND (
                         sgl.cds_stores_class = #{formInfo.class_id}
                      )
                ]]>
            </if>
            <if test="formInfo.brand_id != null and formInfo.brand_id != '' ">
                <![CDATA[
                    AND (
                         c.brand_id = #{formInfo.brand_id}
                      )
                ]]>
            </if>

            <if test="formInfo.good_name != null and formInfo.good_name != '' ">
                <![CDATA[
                    AND (
                        sgl.good_name LIKE '%'+#{formInfo.good_name}+'%' OR
                        sgl.pinxin LIKE '%'+#{formInfo.good_name}+'%'
                      )
                ]]>
            </if>

            <if test="formInfo.good_ids != null and formInfo.good_ids != '' ">
                <![CDATA[
                     ${formInfo.good_ids}
                ]]>
            </if>
            <if test="formInfo.class_ids != null and formInfo.class_ids != '' ">
                <![CDATA[
                     ${formInfo.class_ids}
                ]]>
            </if>
            <if test="formInfo.market_price != null and formInfo.market_price != '' ">
                <![CDATA[
                     and sl.current_price <= #{formInfo.market_price}
                ]]>
            </if>
        </where>
    </select>
</mapper>