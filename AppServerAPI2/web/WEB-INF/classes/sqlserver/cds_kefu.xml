<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC
        "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cds_kefu">

    <!--出餐机信息包含erp商品信息-->
    <select id="get_cf_meal" parameterType="Integer" resultType="HashMap">
        <![CDATA[


            select
                (select '{"good_id":"'+ cast(mg.good_id as varchar(8))
                                +'","good_price":"'+ isnull(cast(mg.good_price as varchar(8)),0)
                                +'","good_num":"'+ cast(mg.good_num as varchar(8))
                                +'","good_name":"'+ cast(mg.good_name as varchar(8))
                                +'","good_key":"'+  cast(mg.good_key as varchar(8))
                                +'","status":"'+ cast(mg.status as varchar(8))
                                +'","out_time":"'+ isnull(cast(mg.out_time as varchar(8)),0)
                                +'","gist":"'+ isnull(mg.gist, '')
                                +'","process":"'+isnull(mg.process, '')
                                +'","class_id":"'+cast(mg.class_id as varchar(8))+'"},'
                from cds_ms_goods mg
                inner join cds_chufan_meal_goods cmg
                on mg.good_id = cmg.good_id
                where cmg.cm_id = cm.cm_id for xml path('')
                                ) as cdsMsGoods,cm.*

            from cds_chufan_meal cm
            where cm.stores_id = #{stores_id}


        ]]>
    </select>

    <!--获取erp商品信息包含原料明细-->
    <select id="getErpInfo" resultType="HashMap">
         <![CDATA[


            select
                (select '{"material_id":"'+ cast(mi.material_id as varchar(8))
                                +'","good_id":"'+ cast(mi.good_id as varchar(8))
                                +'","material_name":"'+ mi.material_name
                                +'","material_num":"'+ cast(mi.material_num as varchar(8))
                                +'","material_unit":"'+ mi.material_unit
                                +'","mi_type":"'+cast(mi.mi_type as varchar(8))+'"},'
                from cds_material_info mi
                where mi.good_id = mg.good_id  for xml path('')
                                ) as cdsMaterialInfo,mg.*
            from cds_ms_goods mg


        ]]>
    </select>

    <!--获取出餐机编号-->
    <select id="getRowID" resultType="Integer">
        select top 1 row_number() over(order by cm_id) AS RowID FROM cds_chufan_meal order by RowID desc
    </select>

    <!--获取出餐机编号-->
    <select id="getMealNum" parameterType="Integer" resultType="Integer">
        select max(ct_num)  from cds_chufan_meal where stores_id = #{stores_id}
    </select>

    <!--获取erp商品编号-->
    <select id="getGoodsNum" parameterType="HashMap" resultType="Map">
        select max(good_num) as max_num  from cds_ms_goods where class_id like #{class_id}
    </select>

    <!--erp商品种类-->
    <select id="getClassType" resultType="HashMap">
        select class_name,class_id from cds_class_type
    </select>

    <!--商品种类-->
    <select id="getClass" resultType="HashMap">
        select class_name,class_id,class_nick_name from cds_class
    </select>

    <!--员工信息-->
    <select id="getUsers" resultType="HashMap">
        select user_login,id,user_nicename from cds_users
    </select>

    <!--获取erp商品列表-->
    <select id="getErpGoods"  resultType="HashMap">
        select mg.good_id,mg.class_id,mg.good_num,mg.status,mg.good_name,mg.out_time,mg.is_sync,
        mg.pinxin,mg.good_price,mg.uptime,mg.good_key,mg.isback,isnull(mg.gist,'') gist,isnull(mg.draftsman,0) draftsman,isnull(mg.approver ,0) approver,isnull(mg.auditor,0) auditor,isnull(mg.process,'') process,mg.finished_weight
        from cds_ms_goods mg
    </select>
    <!--erp列表查询通过上下架,分类，关键字-->
    <select id="getErpGoodsBySelect"  parameterType="HashMap" resultType="HashMap">
        select mg.good_id,mg.class_id,mg.good_num,mg.status,mg.good_name,mg.out_time,mg.is_sync,
        mg.pinxin,mg.good_price,mg.uptime,mg.good_key,mg.isback,isnull(mg.gist,'') gist,isnull(mg.draftsman,0) draftsman,isnull(mg.approver ,0) approver,isnull(mg.auditor,0) auditor,isnull(mg.process,'') process,mg.finished_weight
        from cds_ms_goods mg
        <where>
            <if test="status != null">
                mg.status = #{status}
            </if>
            <if test="class_id != null">
                and mg.class_id = #{class_id}
            </if>
            <if test="good_key != null">
                and mg.good_name like '%'+#{good_key}+'%'
            </if>
        </where>
    </select>



    <!--获取当天该店铺的销售数据-->
    <select id="getSaleInfo" parameterType="HashMap" resultType="HashMap">
        <![CDATA[
        select count(1) count,good_id,price
        from cds_ms_goods_list
        where stores_id = #{stores_id}
        and sale_time > cast(#{date} as varchar)
        and sale_time < cast(#{date} as varchar)  + ' 23:59:59'
        group by good_id,price

        UNION ALL

        select count(1) count,good_id,price
        from view_cds_ms_goods_list
        where stores_id = #{stores_id}
        and sale_time > cast(#{date} as varchar)
        and sale_time < cast(#{date} as varchar)  + ' 23:59:59'
        group by good_id,price

        ]]>
    </select>

    <!--菜品列表-->
    <select id="getGoodsInfo" resultType="HashMap">
        select *,c.class_name from cds_goods_info g
        left join cds_class c
        on g.class_id = c.class_id
    </select>
    <!--获取菜品已添加的erp商品-->
    <select id="getErpGoodsInfo" parameterType="HashMap" resultType="HashMap">
        select mg.good_id,mg.class_id,mg.good_num,mg.status,mg.good_name,mg.out_time,mg.is_sync,
        mg.pinxin,mg.good_price,mg.uptime,mg.good_key,mg.isback,
        isnull(mg.gist,'') gist,isnull(mg.draftsman,0) draftsman,isnull(mg.approver ,0) approver,isnull(mg.auditor,0) auditor,isnull(mg.process,'') process,mg.finished_weight
        ,egl.erp_good_id,egl.good_count
        from cds_ms_goods mg
        left join cds_erp_good_list egl on egl.ms_good_id = mg.good_id
        where egl.good_id = #{good_id}
    </select>

    <!--获取事业部信息-->
    <select id="getBusinessInfo" resultType="HashMap">
       SELECT
          bu.*,
          (SELECT '{"stores_id":"' + cast(s.stores_id AS VARCHAR(8))
                  + '","bsl_id":"' + cast(bsl.bsl_id AS VARCHAR(10))
                  + '","stores_name":"' + cast(s.name AS VARCHAR(20)) + '"},'
           FROM cds_stores s
             LEFT JOIN cds_business_stores_list bsl ON bsl.bu_id = bu.bu_id
           WHERE s.stores_id = bsl.stores_id

           FOR XML PATH ('')
          ) AS stores,
          (SELECT '{"phone":"' + m.phone
                  + '","bsl_id":"' + cast(bml.bsl_id AS VARCHAR(10))
                  + '","member_id":"' + cast(m.member_id AS VARCHAR(10))
                  + '","head_pic":"' +  cast(m.head_pic AS VARCHAR(500))
                  + '","name":"' + m.name + '"},'
           FROM cds_member m
             LEFT JOIN cds_business_member_list bml ON bml.bu_id = bu.bu_id
           WHERE m.member_id = bml.member_id AND m.brand_id = 1
           FOR XML PATH ('')
          ) AS users

        FROM cds_business_unit bu

    </select>
</mapper>